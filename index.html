<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>FAMILIADA TV - FULL SYSTEM</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --led: #eaff00; --glow: 0 0 15px rgba(234, 255, 0, 0.8); }
        body { background: #000; color: var(--led); font-family: 'VT323', monospace; margin: 0; overflow: hidden; text-transform: uppercase; }
        body::after { content: ""; position: fixed; inset: 0; background-image: linear-gradient(rgba(0,0,0,0.9) 2px, transparent 2px), linear-gradient(90deg, rgba(0,0,0,0.9) 2px, transparent 2px); background-size: 4px 4px; z-index: 10000; pointer-events: none; }
        
        .container { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100vw; height: 100vh; }
        
        /* ZWYKŁA TABLICA (Rundy 1-4) */
        #normal-board { width: 80%; display: none; flex-direction: column; gap: 10px; }
        
        /* TABLICA FINAŁOWA */
        #final-board { display: none; grid-template-columns: 1fr 1fr; gap: 40px; width: 90%; }
        
        .row { display: flex; align-items: center; height: 8vh; font-size: 6.5vh; background: #0a0a0a; border: 1px solid #222; padding: 0 20px; }
        .row-num { width: 50px; color: #444; }
        .row-txt { flex-grow: 1; text-shadow: var(--glow); letter-spacing: 2px; }
        .row-pts { width: 100px; text-align: right; color: var(--led); }
        
        #timer { font-size: 18vh; color: #ff3333; text-shadow: 0 0 30px red; margin-bottom: 10px; height: 20vh; visibility: hidden; }
        .total-box { margin-top: 30px; font-size: 9vh; text-shadow: var(--glow); border: 3px solid var(--led); padding: 5px 30px; }
        
        /* IKSY */
        .x-overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.7); z-index: 20000; }
        .x-text { font-size: 400px; color: #eaff00; text-shadow: 0 0 30px red; font-family: sans-serif; font-weight: bold; }

        #welcome { position: fixed; inset: 0; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100000; }
        .hidden-ans { color: #000; text-shadow: none; }
    </style>
</head>
<body>
    <div id="welcome">
        <h1 id="peer-id-display">ŁADOWANIE...</h1>
        <button onclick="document.getElementById('welcome').style.display='none'" style="padding:15px 30px; font-size:20px; cursor:pointer;">ODBLOKUJ DŹWIĘK I EKRAN</button>
    </div>

    <div class="container">
        <div id="timer">00</div>

        <div id="normal-board"></div>

        <div id="final-board">
            <div class="player-col" id="col-p1"></div>
            <div class="player-col" id="col-p2"></div>
        </div>

        <div class="total-box">SUMA: <span id="total-val">0</span></div>
    </div>

    <div id="x-overlay" class="x-overlay"><div class="x-text">X</div></div>

    <audio id="snd-intro" src="intro.mp3"></audio>
    <audio id="snd-ok" src="ok.mp3"></audio>
    <audio id="snd-bad" src="zle.mp3"></audio>
    <audio id="snd-repeat" src="powtorzenia.mp3"></audio>
    <audio id="snd-think" src="think.mp3"></audio>

    <script>
        const peer = new Peer();
        let countdown;
        const aud = (id) => document.getElementById(id);

        peer.on('open', id => document.getElementById('peer-id-display').innerText = "ID: " + id);

        peer.on('connection', conn => {
            conn.on('data', d => {
                if(d.type === 'SOUND') aud(d.id).play();
                
                if(d.type === 'SETUP_NORMAL') {
                    document.getElementById('final-board').style.display = 'none';
                    const nb = document.getElementById('normal-board');
                    nb.style.display = 'flex';
                    nb.innerHTML = d.ans.map((a, i) => `
                        <div class="row">
                            <div class="row-num">${i+1}</div>
                            <div class="row-txt">....................</div>
                            <div class="row-pts"></div>
                        </div>`).join('');
                }

                if(d.type === 'SETUP_FINAL') {
                    document.getElementById('normal-board').style.display = 'none';
                    document.getElementById('final-board').style.display = 'grid';
                    const fill = (id) => {
                        document.getElementById(id).innerHTML = Array(5).fill().map(() => `
                            <div class="row"><div class="row-txt">...</div><div class="row-pts"></div></div>
                        `).join('');
                    };
                    fill('col-p1'); fill('col-p2');
                }

                if(d.type === 'REV') {
                    aud('snd-ok').play();
                    let row;
                    if(d.mode === 'normal') row = document.getElementById('normal-board').children[d.idx];
                    else row = document.getElementById('col-p'+d.player).children[d.idx];
                    
                    row.querySelector('.row-txt').innerText = d.t;
                    row.querySelector('.row-txt').classList.remove('hidden-ans');
                    row.querySelector('.row-pts').innerText = d.p;
                }

                if(d.type === 'X') {
                    aud('snd-bad').play();
                    const ov = document.getElementById('x-overlay');
                    ov.querySelector('.x-text').innerText = "X".repeat(d.count);
                    ov.style.display = 'flex';
                    setTimeout(() => ov.style.display = 'none', 2000);
                }

                if(d.type === 'TIMER') {
                    const tEl = document.getElementById('timer');
                    tEl.style.visibility = 'visible';
                    let time = d.sec;
                    tEl.innerText = time;
                    aud('snd-think').play();
                    clearInterval(countdown);
                    countdown = setInterval(() => {
                        time--; tEl.innerText = time;
                        if(time <= 0) { 
                            clearInterval(countdown); 
                            aud('snd-think').pause(); aud('snd-bad').play();
                        }
                    }, 1000);
                }

                if(d.type === 'HIDE_P1') {
                    document.querySelectorAll('#col-p1 .row-txt').forEach(r => r.classList.add('hidden-ans'));
                }

                if(d.type === 'SCORE') document.getElementById('total-val').innerText = d.val;
            });
        });
    </script>
</body>
</html>
