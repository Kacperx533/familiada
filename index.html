<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>FAMILIADA - LED MATRIX</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { 
            --led-yellow: #ffea00; 
            --tile-dim: #1a1b20; /* Wyłączona dioda */
            --bg-dark: #0a0a0c;
        }

        body { 
            margin: 0; padding: 0; 
            background: linear-gradient(90deg, #ff2a6d 0%, #3d6eff 100%) fixed;
            display: flex; justify-content: center; align-items: center; 
            height: 100vh; overflow: hidden;
            font-family: 'VT323', monospace;
        }

        /* Obudowa tablicy */
        .board-outer {
            background-color: #121216;
            padding: 15px;
            border-radius: 25px;
            box-shadow: 0 50px 100px rgba(0,0,0,0.7);
            border: 4px solid #1e1e24;
            position: relative;
        }

        /* Siatka LED - Gęste "oczka" */
        .matrix-grid {
            display: grid;
            /* Tworzymy gęstą siatkę 34x18, aby uzyskać efekt drobnych punktów */
            grid-template-columns: repeat(34, 25px);
            grid-template-rows: repeat(18, 25px);
            gap: 4px; /* Przerwy między diodami (siatka) */
            background-color: #050505;
            padding: 10px;
            border-radius: 15px;
        }

        /* Pojedyncze oczko matrycy */
        .led {
            width: 25px;
            height: 25px;
            background-color: var(--tile-dim);
            border-radius: 4px; /* Zaokrąglone rogi oczek LED */
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* Świecący znak na matrycy */
        .active-char {
            color: var(--led-yellow);
            font-size: 38px; /* Rozmiar dopasowany do oczka */
            line-height: 1;
            text-shadow: 0 0 12px rgba(255, 234, 0, 0.7);
            font-weight: bold;
            z-index: 2;
            /* Rozciągnięcie jak na starych ekranach */
            transform: scale(1.1, 1.3);
        }

        /* Specjalny Styl dla X (Błędów) */
        .x-block {
            grid-column: span 2;
            grid-row: span 3;
            position: relative;
            display: none; /* Domyślnie ukryte */
        }
        
        .x-line {
            position: absolute;
            background-color: var(--led-yellow);
            box-shadow: 0 0 15px var(--led-yellow);
            border-radius: 10px;
            width: 15%; height: 100%;
            left: 42.5%;
        }
        .x-l1 { transform: rotate(45deg); }
        .x-l2 { transform: rotate(-45deg); }

        /* Panel startowy */
        #init-layer { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; display: flex; justify-content: center; align-items: center; }
        button { padding: 20px 40px; font-size: 24px; cursor: pointer; background: var(--led-yellow); border: none; border-radius: 10px; font-family: 'VT323'; }
    </style>
</head>
<body>

<div id="init-layer">
    <button onclick="bootMatrix()">URUCHOM MATRYCĘ LED</button>
</div>

<div class="board-outer">
    <div class="matrix-grid" id="main-matrix">
        </div>
</div>

<audio id="s-ok" src="ok.mp3"></audio>
<audio id="s-err" src="zle.mp3"></audio>

<script>
    const matrix = document.getElementById('main-matrix');
    const cols = 34;
    const rows = 18;

    // 1. Generujemy tło matrycy (puste oczka)
    function buildGrid() {
        matrix.innerHTML = '';
        for (let r = 0; r < rows; r++) {
            for (let c = 0; c < cols; c++) {
                const led = document.createElement('div');
                led.className = 'led';
                led.id = `led-${r}-${c}`;
                matrix.appendChild(led);
            }
        }
        // Wstawiamy X-y w stałe miejsca na siatce (prawa strona)
        insertX(2, 'x1');
        insertX(6, 'x2');
        insertX(10, 'x3');
    }

    function insertX(row, id) {
        const xBox = document.createElement('div');
        xBox.className = 'x-block';
        xBox.id = id;
        xBox.style.gridRow = `${row + 1} / span 3`;
        xBox.style.gridColumn = `31 / span 2`;
        xBox.innerHTML = '<div class="x-line x-l1"></div><div class="x-line x-l2"></div>';
        matrix.appendChild(xBox);
    }

    // 2. Funkcja do "zapalania" znaku w konkretnym oczku
    function setLed(r, c, char) {
        const target = document.getElementById(`led-${r}-${c}`);
        if (target) {
            target.innerHTML = char ? `<span class="active-char">${char}</span>` : '';
        }
    }

    // 3. Renderowanie całego wiersza (numer, tekst, punkty)
    function renderRow(rowIndex, num, text, points) {
        const r = 3 + (rowIndex * 2); // Odstępy pionowe
        
        // Numer (kolumna 4)
        setLed(r, 4, num);

        // Tekst (od kolumny 6)
        const fullText = text.toUpperCase().padEnd(20, '.');
        for (let i = 0; i < 20; i++) {
            setLed(r, 6 + i, fullText[i]);
        }

        // Punkty (kolumny 27-28)
        const pStr = points.toString().padStart(2, '-');
        setLed(r, 27, pStr[0]);
        setLed(r, 28, pStr[1]);
    }

    function renderSuma(val) {
        const sTxt = "SUMA";
        for(let i=0; i<4; i++) setLed(15, 20+i, sTxt[i]);
        const vStr = val.toString().padStart(1, '0');
        setLed(15, 25, vStr[0]);
        if(vStr[1]) setLed(15, 26, vStr[1]);
    }

    function bootMatrix() {
        const code = Math.random().toString(36).substring(2,5).toUpperCase();
        alert("TWÓJ KOD: " + code);
        const peer = new Peer(code);
        
        peer.on('connection', conn => {
            document.getElementById('init-layer').style.display = 'none';
            conn.on('data', data => {
                if(data.type === 'SET') {
                    buildGrid();
                    for(let i=0; i<data.c; i++) renderRow(i, i+1, "", "--");
                    renderSuma(0);
                }
                if(data.type === 'REV') {
                    renderRow(data.i, data.i+1, data.t, data.p);
                    renderSuma(data.s);
                    document.getElementById('s-ok').play();
                }
                if(data.type === 'X') {
                    for(let i=1; i<=3; i++) {
                        document.getElementById('x'+i).style.display = (i <= data.count) ? 'block' : 'none';
                    }
                    document.getElementById('s-err').play();
                }
            });
        });
    }

    buildGrid(); // Startowa siatka
</script>
</body>
</html>
