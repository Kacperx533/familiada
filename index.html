<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>FAMILIADA - MAX SIZE</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { 
            --led-yellow: #fff200; /* Bardzo jasny żółty */
            --board-gap: #111;     /* Ciemne przerwy */
            --tile-bg: #1a1a20;    /* Tło kafelka */
        }

        body { 
            margin: 0; padding: 0; 
            /* Gradient tła */
            background: linear-gradient(90deg, #f02d6b 0%, #6081ff 100%) fixed;
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            height: 100vh; overflow: hidden;
            font-family: 'VT323', monospace;
        }

        /* Ramka Tablicy */
        .board-frame {
            background-color: #121214;
            padding: 20px;
            border-radius: 35px;
            box-shadow: 0 40px 100px rgba(0,0,0,0.8);
            width: 95vw;          /* Prawie cała szerokość ekranu */
            height: 85vh;         /* Wysoka tablica */
            box-sizing: border-box;
            position: relative;
            border: 4px solid #222;
        }

        /* Siatka (Grid) - Kafelki */
        .led-grid {
            width: 100%;
            height: 100%;
            display: grid;
            /* 32 kolumny x 16 wierszy */
            grid-template-columns: repeat(32, 1fr);
            grid-template-rows: repeat(16, 1fr);
            gap: 4px; /* Małe odstępy, żeby litery były większe */
        }

        /* Pojedynczy kafelek */
        .tile {
            background-color: var(--tile-bg);
            border-radius: 4px;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* Styl Liter - WIELKIE */
        .char {
            color: var(--led-yellow);
            font-size: 5.5vh; /* Skaluje się z wysokością ekranu - bardzo duże */
            line-height: 1;
            font-weight: bold;
            text-transform: uppercase;
            text-shadow: 0 0 8px rgba(255, 242, 0, 0.6); /* Efekt świecenia */
            margin-top: -5px; /* Korekta, żeby litera była idealnie na środku */
        }

        /* Styl X (Błąd) - Segmentowy */
        .x-wrapper {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10;
            display: none; /* Domyślnie ukryte */
        }
        
        /* Budowa X z grubych kresek */
        .x-bar {
            position: absolute;
            background-color: var(--led-yellow);
            box-shadow: 0 0 15px var(--led-yellow);
            border-radius: 6px;
        }

        /* X zajmuje obszar 2x3 kafelków. Musimy to ustawić ręcznie w CSS dla każdego X */
        /* Klasy pomocnicze do pozycjonowania X */
        .x-pos-1 { grid-column: 30 / span 2; grid-row: 3 / span 3; position: relative; display: none; }
        .x-pos-2 { grid-column: 30 / span 2; grid-row: 7 / span 3; position: relative; display: none; }
        .x-pos-3 { grid-column: 30 / span 2; grid-row: 11 / span 3; position: relative; display: none; }

        /* Kreski X */
        .bar-1 { 
            width: 18%; height: 100%; 
            left: 41%; top: 0; 
            transform: rotate(45deg); 
        }
        .bar-2 { 
            width: 18%; height: 100%; 
            left: 41%; top: 0; 
            transform: rotate(-45deg); 
        }

        /* Panel testowy (żebyś widział że działa) */
        #controls {
            position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px; z-index: 9999;
        }
        button { padding: 10px 20px; font-weight: bold; cursor: pointer; border: none; border-radius: 5px; background: #fff; }
        .btn-hide { opacity: 0.3; }
        .btn-hide:hover { opacity: 1; }

    </style>
</head>
<body>

    <div class="board-frame">
        <div class="led-grid" id="main-grid">
            </div>
    </div>

    <div id="controls" class="btn-hide">
        <button onclick="testText()">TEST NAPISÓW</button>
        <button onclick="testX(1)">POKAŻ X1</button>
        <button onclick="testX(2)">POKAŻ X2</button>
        <button onclick="testX(3)">POKAŻ X3</button>
        <button onclick="clearAll()">CZYŚĆ</button>
        <button onclick="connectPeer()" style="background:gold">POŁĄCZ (PEER)</button>
    </div>

    <audio id="s-ok" src="ok.mp3"></audio>
    <audio id="s-zle" src="zle.mp3"></audio>

    <script>
        const rows = 16;
        const cols = 32;
        const grid = document.getElementById('main-grid');
        let tileMap = []; // Mapa do łatwego dostępu: tileMap[y][x]

        // 1. GENERUJEMY KAFELKI
        function initGrid() {
            grid.innerHTML = '';
            tileMap = [];
            for(let r=0; r<rows; r++) {
                let rowArr = [];
                for(let c=0; c<cols; c++) {
                    const div = document.createElement('div');
                    div.className = 'tile';
                    div.id = `t-${r}-${c}`;
                    
                    // Specjalna obsługa dla pól, gdzie ma być X (łączymy kafelki wizualnie w CSS, tutaj logicznie)
                    // Ale prościej jest nałożyć X na wierzch.
                    // Zrobimy to grid-layoutem.
                    
                    grid.appendChild(div);
                    rowArr.push(div);
                }
                tileMap.push(rowArr);
            }
            createXContainers();
        }

        // 2. TWORZENIE KONTENERÓW NA X (Nakładki)
        function createXContainers() {
            // X1
            const x1 = document.createElement('div');
            x1.className = 'x-pos-1';
            x1.id = 'x-box-1';
            x1.innerHTML = `<div class="x-bar bar-1"></div><div class="x-bar bar-2"></div>`;
            grid.appendChild(x1); // Grid automatycznie go ustawi

            // X2
            const x2 = document.createElement('div');
            x2.className = 'x-pos-2';
            x2.id = 'x-box-2';
            x2.innerHTML = `<div class="x-bar bar-1"></div><div class="x-bar bar-2"></div>`;
            grid.appendChild(x2);

            // X3
            const x3 = document.createElement('div');
            x3.className = 'x-pos-3';
            x3.id = 'x-box-3';
            x3.innerHTML = `<div class="x-bar bar-1"></div><div class="x-bar bar-2"></div>`;
            grid.appendChild(x3);
        }

        initGrid();

        // --- FUNKCJE RYSOWANIA ---

        function drawChar(r, c, char) {
            if(r >= rows || c >= cols) return;
            const tile = document.getElementById(`t-${r}-${c}`);
            if(tile) {
                tile.innerHTML = `<span class="char">${char}</span>`;
            }
        }

        function clearTile(r, c) {
            const tile = document.getElementById(`t-${r}-${c}`);
            if(tile) tile.innerHTML = '';
        }

        // Rysowanie całego wiersza
        function drawRow(rowIndex, number, text, points) {
            // Numer (Kolumna 3)
            drawChar(rowIndex, 3, number);

            // Tekst (Od kolumny 5)
            text = text.toUpperCase();
            for(let i=0; i<20; i++) { // Max 20 znaków
                if(i < text.length) {
                    drawChar(rowIndex, 5+i, text[i]);
                } else {
                    drawChar(rowIndex, 5+i, '.'); // Kropki jak brak liter
                }
            }

            // Punkty (Kolumny 26-27)
            const ptsStr = points.toString().padStart(2, '-'); // "--" albo "05"
            drawChar(rowIndex, 26, ptsStr[0]);
            drawChar(rowIndex, 27, ptsStr[1]);
        }

        // --- LOGIKA POŁĄCZENIA ---
        let peer;
        function connectPeer() {
            const id = Math.random().toString(36).substring(2,5).toUpperCase();
            alert("KOD: " + id);
            peer = new Peer(id);
            peer.on('connection', conn => {
                conn.on('data', data => {
                    handleData(data);
                });
            });
        }

        function handleData(data) {
            if(data.type === 'SET') {
                clearAll();
                // Rysuj puste linie
                for(let i=0; i<data.c; i++) {
                    let r = 2 + (i*2); // Wiersze 2, 4, 6...
                    drawRow(r, i+1, "", "--");
                }
                drawSuma(0);
            }
            if(data.type === 'REV') {
                let r = 2 + (data.i*2);
                drawRow(r, data.i+1, data.t, data.p);
                drawSuma(data.s);
                document.getElementById('s-ok').play();
            }
            if(data.type === 'X') {
                showX(data.count);
                document.getElementById('s-zle').play();
            }
        }

        function drawSuma(val) {
            // Napis SUMA (Wiersz 14, Kol 20-23)
            const text = "SUMA";
            for(let i=0; i<4; i++) drawChar(14, 20+i, text[i]);
            
            // Wartość (Wiersz 14, Kol 25-27)
            const valStr = val.toString();
            drawChar(14, 25, valStr.length > 1 ? valStr[0] : '0'); // Dziesiątki lub 0
            drawChar(14, 26, valStr.length > 1 ? valStr[1] : valStr[0]); // Jedności
        }

        function showX(count) {
            // Ukryj wszystkie najpierw
            document.getElementById('x-box-1').style.display = 'none';
            document.getElementById('x-box-2').style.display = 'none';
            document.getElementById('x-box-3').style.display = 'none';

            if(count >= 1) document.getElementById('x-box-1').style.display = 'block';
            if(count >= 2) document.getElementById('x-box-2').style.display = 'block';
            if(count >= 3) document.getElementById('x-box-3').style.display = 'block';
        }

        function clearAll() {
            // Czyść treść kafelków
            document.querySelectorAll('.tile').forEach(t => t.innerHTML = '');
            // Ukryj X
            showX(0);
        }

        // --- FUNKCJE TESTOWE ---
        function testText() {
            clearAll();
            drawRow(2, 1, "PASTERZ", "28");
            drawRow(4, 2, "PASTA", "26");
            drawRow(6, 3, "PASTORALKA", "17");
            drawRow(8, 4, "....................", "--");
            drawRow(10, 5, "....................", "--");
            drawSuma(71);
        }

        function testX(n) {
            showX(n);
        }

    </script>
</body>
</html>
