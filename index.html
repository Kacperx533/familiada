<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>FAMILIADA TV - WERSJA FINALNA</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --led: #dfff00; --red: #ff3333; --bg: #050505; }
        body { background: var(--bg); color: var(--led); font-family: 'VT323', monospace; margin: 0; overflow: hidden; height: 100vh; text-transform: uppercase; }
        .led-overlay { position: fixed; inset: 0; background: radial-gradient(circle, transparent 30%, #000 80%) 0 0 / 5px 5px; pointer-events: none; z-index: 1000; opacity: 0.5; }
        
        .stage { display: grid; grid-template-columns: 180px 1fr 180px; width: 98vw; height: 90vh; margin: 5vh auto; gap: 20px; }
        
        /* IKSY */
        .side-x { display: flex; flex-direction: column; gap: 15px; justify-content: center; }
        .x-box { width: 160px; height: 160px; border: 4px solid #1a1a1a; display: flex; justify-content: center; align-items: center; transition: 0.2s; position: relative; }
        /* Kropkowy wzór X ze zdjęcia */
        .x-box::before { content: "X"; font-size: 140px; color: #151515; }
        .x-box.active::before { color: var(--red); text-shadow: 0 0 30px var(--red); }

        /* TABLICA */
        .board { display: flex; flex-direction: column; position: relative; border: 4px solid #111; background: rgba(10,10,10,0.9); padding: 20px; }
        
        /* Układ Finałowy (2 kolumny) */
        .final-container { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; height: 100%; }
        .final-col { display: flex; flex-direction: column; }
        
        .row { display: flex; align-items: center; height: 11vh; font-size: 7vh; border-bottom: 2px solid #222; margin-bottom: 5px; }
        .row-txt { flex-grow: 1; padding-left: 20px; letter-spacing: 2px; }
        .row-pts { width: 100px; text-align: right; padding-right: 20px; color: var(--led); }
        .dots::after { content: "...................."; opacity: 0.1; }

        .sum-box { position: absolute; bottom: 10px; right: 40px; font-size: 9vh; display: flex; gap: 20px; border-top: 3px solid #333; }
        #timer-display { position: absolute; bottom: 20px; left: 40px; font-size: 12vh; color: var(--red); display: none; }
        
        #msg-overlay { position: fixed; inset: 0; background: var(--bg); display: flex; justify-content: center; align-items: center; z-index: 2000; font-size: 10vh; text-align: center; }
    </style>
</head>
<body>
    <div class="led-overlay"></div>
    <div id="msg-overlay">OCZEKIWANIE NA POŁĄCZENIE...</div>
    <div id="timer-display">00</div>

    <div class="stage">
        <div class="side-x"><div class="x-box" id="L1"></div><div class="x-box" id="L2"></div><div class="x-box" id="L3"></div></div>
        
        <div class="board" id="board-content">
            <div id="main-display" style="width:100%; height:100%"></div>
            <div class="sum-box"><span>SUMA</span><span id="total-val">0</span></div>
        </div>

        <div class="side-x"><div class="x-box" id="R1"></div><div class="x-box" id="R2"></div><div class="x-box" id="R3"></div></div>
    </div>

    <audio id="snd-ok" src="ok.mp3"></audio>
    <audio id="snd-bad" src="zla.mp3"></audio>
    <audio id="snd-runda" src="runda.mp3"></audio> <audio id="snd-final" src="final.mp4"></audio> <audio id="snd-timer" src="czas.mp3"></audio>

    <script>
        const peer = new Peer();
        const display = document.getElementById('main-display');
        let currentData = { p1: [], p2: [], normal: [] };

        peer.on('open', id => document.getElementById('msg-overlay').innerText = "KOD: " + id);

        function renderNormal(ans) {
            display.innerHTML = ans.map((a, i) => `
                <div class="row">
                    <div style="width:50px">${i+1}</div>
                    <div class="row-txt ${a.rev ? '' : 'dots'}">${a.rev ? a.t : ''}</div>
                    <div class="row-pts">${a.rev ? a.p : ''}</div>
                </div>
            `).join('');
        }

        function renderFinal(p1, p2) {
            let html = '<div class="final-container"><div class="final-col">';
            for(let i=0; i<5; i++) {
                html += `<div class="row"><div class="row-txt ${p1[i]?.rev ? '' : 'dots'}">${p1[i]?.rev ? p1[i].t : ''}</div><div class="row-pts">${p1[i]?.rev ? p1[i].p : ''}</div></div>`;
            }
            html += '</div><div class="final-col">';
            for(let i=0; i<5; i++) {
                html += `<div class="row"><div class="row-txt ${p2[i]?.rev ? '' : 'dots'}">${p2[i]?.rev ? p2[i].t : ''}</div><div class="row-pts">${p2[i]?.rev ? p2[i].p : ''}</div></div>`;
            }
            html += '</div></div>';
            display.innerHTML = html;
        }

        peer.on('connection', conn => {
            document.getElementById('msg-overlay').style.display = 'none';
            conn.on('data', data => {
                if(data.type === 'SOUND') {
                    if(data.file === 'runda') document.getElementById('snd-runda').play();
                    if(data.file === 'final') document.getElementById('snd-final').play();
                }
                if(data.type === 'TIMER') {
                    const disp = document.getElementById('timer-display');
                    disp.style.display = data.action === 'stop' ? 'none' : 'block';
                    disp.innerText = data.val;
                    if(data.action === 'start') document.getElementById('snd-timer').play();
                }
                if(data.type === 'SETUP_NORMAL') {
                    currentData.normal = data.ans.map(a => ({...a, rev: false}));
                    renderNormal(currentData.normal);
                }
                if(data.type === 'SETUP_FINAL') {
                    currentData.p1 = Array(5).fill({t:'', p:0, rev:false});
                    currentData.p2 = Array(5).fill({t:'', p:0, rev:false});
                    renderFinal(currentData.p1, currentData.p2);
                }
                if(data.type === 'REV_NORMAL') {
                    document.getElementById('snd-ok').play();
                    currentData.normal[data.idx].rev = true;
                    renderNormal(currentData.normal);
                }
                if(data.type === 'REV_FINAL') {
                    document.getElementById('snd-ok').play();
                    currentData[data.player][data.idx] = { t: data.t, p: data.p, rev: true };
                    renderFinal(currentData.p1, currentData.p2);
                }
                if(data.type === 'SCORE') document.getElementById('total-val').innerText = data.val;
                if(data.type === 'X') {
                    document.getElementById('snd-bad').play();
                    for(let i=1; i<=3; i++) document.getElementById(data.side+i).classList.toggle('active', i<=data.n);
                }
            });
        });
    </script>
</body>
</html>
