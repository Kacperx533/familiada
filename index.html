<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>FAMILIADA - COMPACT</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { 
            --yellow: #ffea00; 
            --bg-board: #111;
            --tile-bg: #18181a;
        }

        body { 
            margin: 0; padding: 0; 
            background: linear-gradient(90deg, #f02d6b 0%, #6081ff 100%) fixed;
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            height: 100vh; overflow: hidden;
            font-family: 'VT323', monospace;
        }

        .board-frame {
            background-color: #000;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 40px 100px rgba(0,0,0,0.9);
            width: 95vw;
            height: 85vh;
            border: 5px solid #222;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .led-grid {
            display: grid;
            /* 30 kolumn (zamiast 32, żeby były szersze) */
            grid-template-columns: repeat(30, 1fr);
            grid-template-rows: repeat(15, 1fr);
            /* BARDZO MAŁY ODSTĘP - TO SPRAWIA ŻE SĄ BLISKO SIEBIE */
            gap: 2px; 
            width: 100%;
            height: 100%;
            background-color: #000;
        }

        .tile {
            background-color: var(--tile-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden; /* Ważne przy powiększaniu */
            position: relative;
        }

        /* LITERKI - ROZCIĄGNIĘTE I DUŻE */
        .char {
            color: var(--yellow);
            font-size: 6vh; /* Bazowa wielkość */
            line-height: 1;
            font-weight: bold;
            /* To sprawia, że litera nie jest "rozlazła" tylko wypełnia kafel */
            transform: scale(1.4, 1.6); 
            text-shadow: 0 0 10px rgba(255, 234, 0, 0.5);
            margin-top: -2px;
        }

        /* STYL X (BŁĘDU) */
        .x-overlay {
            position: absolute;
            inset: 0;
            background: transparent;
            display: none;
            z-index: 10;
        }
        .x-shape {
            position: absolute;
            background-color: var(--yellow);
            box-shadow: 0 0 15px var(--yellow);
        }
        /* Dwie belki X */
        .x-arm1 { width: 20%; height: 120%; left: 40%; top: -10%; transform: rotate(45deg); }
        .x-arm2 { width: 20%; height: 120%; left: 40%; top: -10%; transform: rotate(-45deg); }

        /* Kontenery na X (zajmują 3 kafelki w pionie i 2 w poziomie) */
        .x-box {
            grid-column: span 2;
            grid-row: span 3;
            position: relative;
            display: none; /* Ukryte startowo */
        }

        /* Przyciski */
        #controls { position: fixed; bottom: 10px; z-index: 99; display: flex; gap: 10px; }
        button { padding: 15px 30px; font-weight: bold; cursor: pointer; font-size: 18px; border:none; border-radius: 5px; }
    </style>
</head>
<body>

    <div class="board-frame">
        <div class="led-grid" id="grid"></div>
    </div>

    <div id="controls">
        <button onclick="testView()">TEST TEKSTU</button>
        <button onclick="showX(1)">X 1</button>
        <button onclick="showX(2)">X 2</button>
        <button onclick="showX(3)">X 3</button>
        <button onclick="clearBoard()">CZYŚĆ</button>
        <button onclick="initPeer()" style="background:#ffea00">POŁĄCZ</button>
    </div>

    <audio id="s-ok" src="ok.mp3"></audio>
    <audio id="s-zle" src="zle.mp3"></audio>

    <script>
        const rows = 15;
        const cols = 30; // Mniej kolumn = szersze kafelki
        const grid = document.getElementById('grid');

        // Generowanie siatki
        function makeGrid() {
            grid.innerHTML = '';
            for(let i=0; i<rows*cols; i++) {
                // Oblicz pozycję X (0-29) i Y (0-14)
                let c = i % cols;
                let r = Math.floor(i / cols);

                // Sprawdź czy tu ma być kontener na X (ręcznie wstawiamy w konkretne miejsca)
                // X1: wiersz 2, kol 27
                if(r===2 && c===27) { addXBox('x-box-1'); continue; }
                if(r>=2 && r<=4 && c>=27 && c<=28) continue; // Pomiń te kafelki, bo zajmuje je X1

                // X2: wiersz 6, kol 27
                if(r===6 && c===27) { addXBox('x-box-2'); continue; }
                if(r>=6 && r<=8 && c>=27 && c<=28) continue;

                // X3: wiersz 10, kol 27
                if(r===10 && c===27) { addXBox('x-box-3'); continue; }
                if(r>=10 && r<=12 && c>=27 && c<=28) continue;

                // Zwykły kafelek
                const div = document.createElement('div');
                div.className = 'tile';
                div.id = `t-${r}-${c}`;
                grid.appendChild(div);
            }
        }

        function addXBox(id) {
            const div = document.createElement('div');
            div.className = 'x-box';
            div.id = id;
            div.innerHTML = `<div class="x-shape x-arm1"></div><div class="x-shape x-arm2"></div>`;
            grid.appendChild(div);
        }

        makeGrid();

        // Rysowanie
        function draw(r, c, char) {
            const el = document.getElementById(`t-${r}-${c}`);
            if(el) el.innerHTML = `<span class="char">${char}</span>`;
        }

        function drawRow(r, num, txt, pts) {
            // Numer (kolumna 2)
            draw(r, 2, num);
            
            // Tekst (od kolumny 4 do 23)
            txt = txt.toUpperCase();
            for(let i=0; i<20; i++) {
                if(i < txt.length) draw(r, 4+i, txt[i]);
                else draw(r, 4+i, '.');
            }

            // Punkty (kolumna 25-26)
            let p = pts.toString().padStart(2, '0');
            if(pts === '--') p = '--';
            draw(r, 25, p[0]);
            draw(r, 26, p[1]);
        }

        function drawSum(val) {
            const txt = "SUMA";
            for(let i=0; i<4; i++) draw(13, 18+i, txt[i]);
            let s = val.toString();
            if(s.length<2) s = "0"+s;
            draw(13, 23, s[0]);
            draw(13, 24, s[1]); // Suma blisko napisu
        }

        function testView() {
            clearBoard();
            drawRow(2, 1, "WARSZAWA", 35);
            drawRow(4, 2, "KRAKOW", 28);
            drawRow(6, 3, "POZNAN", 15);
            drawRow(8, 4, "....................", "--");
            drawRow(10, 5, "....................", "--");
            drawSum(78);
        }

        function showX(n) {
            document.getElementById('x-box-1').style.display = n>=1 ? 'block' : 'none';
            document.getElementById('x-box-2').style.display = n>=2 ? 'block' : 'none';
            document.getElementById('x-box-3').style.display = n>=3 ? 'block' : 'none';
        }

        function clearBoard() {
            document.querySelectorAll('.tile').forEach(t => t.innerHTML = '');
            showX(0);
        }

        // PeerJS
        let peer;
        function initPeer() {
            const id = Math.random().toString(36).substring(2,5).toUpperCase();
            alert("KOD: " + id);
            peer = new Peer(id);
            peer.on('connection', conn => {
                conn.on('data', d => {
                    if(d.type==='SET') {
                        clearBoard();
                        for(let i=0; i<d.c; i++) drawRow(2+i*2, i+1, "", "--");
                        drawSum(0);
                    }
                    if(d.type==='REV') {
                        drawRow(2+d.i*2, d.i+1, d.t, d.p);
                        drawSum(d.s);
                        document.getElementById('s-ok').play();
                    }
                    if(d.type==='X') {
                        showX(d.count);
                        document.getElementById('s-zle').play();
                    }
                });
            });
        }
    </script>
</body>
</html>
