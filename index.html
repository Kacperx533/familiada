<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>FAMILIADA - EKRAN TV</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --led: #dfff00; --red: #ff3333; --bg: #050505; }
        body { background: var(--bg); color: var(--led); font-family: 'VT323', monospace; margin: 0; overflow: hidden; height: 100vh; text-transform: uppercase; }
        
        /* Warstwa Wideo */
        #video-layer { position: fixed; inset: 0; background: black; z-index: 5000; display: none; }
        video { width: 100%; height: 100%; object-fit: contain; }

        .led-overlay { position: fixed; inset: 0; background: radial-gradient(circle, transparent 30%, #000 80%) 0 0 / 5px 5px; pointer-events: none; z-index: 1000; opacity: 0.4; }
        .stage { display: grid; grid-template-columns: 180px 1fr 180px; width: 98vw; height: 90vh; margin: 5vh auto; gap: 20px; }
        
        /* Iksy */
        .side-x { display: flex; flex-direction: column; gap: 15px; justify-content: center; }
        .x-box { width: 160px; height: 160px; border: 4px solid #1a1a1a; display: flex; justify-content: center; align-items: center; }
        .x-box::before { content: "X"; font-size: 140px; color: #151515; }
        .x-box.active::before { color: var(--red); text-shadow: 0 0 30px var(--red); }

        /* Tablica */
        .board { display: flex; flex-direction: column; position: relative; border: 4px solid #111; background: rgba(10,10,10,0.9); padding: 20px; }
        .final-container { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; height: 100%; }
        .row { display: flex; align-items: center; height: 11vh; font-size: 7vh; border-bottom: 2px solid #222; margin-bottom: 5px; }
        .row-txt { flex-grow: 1; padding-left: 20px; letter-spacing: 2px; white-space: nowrap; overflow: hidden; }
        .row-pts { width: 100px; text-align: right; padding-right: 20px; }
        .dots::after { content: "...................."; opacity: 0.1; }

        .sum-box { position: absolute; bottom: 10px; right: 40px; font-size: 9vh; display: flex; gap: 20px; border-top: 3px solid #333; }
        #timer-display { position: absolute; bottom: 20px; left: 40px; font-size: 12vh; color: var(--red); display: none; }
        #msg-overlay { position: fixed; inset: 0; background: var(--bg); display: flex; justify-content: center; align-items: center; z-index: 6000; font-size: 8vh; }
    </style>
</head>
<body>
    <div id="video-layer"><video id="vid-player"></video></div>
    <div class="led-overlay"></div>
    <div id="msg-overlay">≈ÅADOWANIE ID...</div>
    <div id="timer-display">00</div>

    <div class="stage">
        <div class="side-x"><div class="x-box" id="L1"></div><div class="x-box" id="L2"></div><div class="x-box" id="L3"></div></div>
        <div class="board">
            <div id="main-display" style="height: 100%;"></div>
            <div class="sum-box"><span>SUMA</span><span id="total-val">0</span></div>
        </div>
        <div class="side-x"><div class="x-box" id="R1"></div><div class="x-box" id="R2"></div><div class="x-box" id="R3"></div></div>
    </div>

    <audio id="snd-ok" src="ok.mp3"></audio>
    <audio id="snd-bad" src="zla.mp3"></audio>
    <audio id="snd-runda" src="runda.mp3"></audio>
    <audio id="snd-timer" src="czas.mp3"></audio>

    <script>
        const peer = new Peer();
        const display = document.getElementById('main-display');
        const vidLayer = document.getElementById('video-layer');
        const vidPlayer = document.getElementById('vid-player');
        let currentData = { p1: [], p2: [], normal: [] };

        peer.on('open', id => document.getElementById('msg-overlay').innerText = "KOD PANELU: " + id);

        peer.on('connection', conn => {
            document.getElementById('msg-overlay').style.display = 'none';
            conn.on('data', d => {
                if(d.type === 'PLAY_MEDIA') {
                    if(d.video) {
                        vidLayer.style.display = 'block';
                        vidPlayer.src = d.video;
                        vidPlayer.play();
                        vidPlayer.onended = () => vidLayer.style.display = 'none';
                    }
                    if(d.audio) document.getElementById('snd-' + d.audio).play();
                }
                if(d.type === 'STOP_VIDEO') { vidLayer.style.display = 'none'; vidPlayer.pause(); }
                if(d.type === 'TIMER') {
                    const t = document.getElementById('timer-display');
                    t.innerText = d.val; t.style.display = d.action === 'stop' ? 'none' : 'block';
                    if(d.action === 'start') document.getElementById('snd-timer').play();
                }
                if(d.type === 'SETUP_NORMAL') {
                    currentData.normal = d.ans.map(a => ({...a, rev: false}));
                    display.innerHTML = currentData.normal.map((a, i) => `
                        <div class="row">
                            <div style="width:50px">${i+1}</div>
                            <div class="row-txt dots"></div>
                            <div class="row-pts"></div>
                        </div>`).join('');
                }
                if(d.type === 'SETUP_FINAL') {
                    currentData.p1 = Array(5).fill({rev: false});
                    currentData.p2 = Array(5).fill({rev: false});
                    renderFinal();
                }
                if(d.type === 'REV_NORMAL') {
                    document.getElementById('snd-ok').play();
                    currentData.normal[d.idx].rev = true;
                    display.innerHTML = currentData.normal.map((a, i) => `
                        <div class="row">
                            <div style="width:50px">${i+1}</div>
                            <div class="row-txt ${a.rev ? '' : 'dots'}">${a.rev ? a.t : ''}</div>
                            <div class="row-pts">${a.rev ? a.p : ''}</div>
                        </div>`).join('');
                }
                if(d.type === 'REV_FINAL') {
                    document.getElementById('snd-ok').play();
                    currentData[d.player][d.idx] = { t: d.t, p: d.p, rev: true };
                    renderFinal();
                }
                if(d.type === 'SCORE') document.getElementById('total-val').innerText = d.val;
                if(d.type === 'X') {
                    document.getElementById('snd-bad').play();
                    for(let i=1; i<=3; i++) document.getElementById(d.side+i).classList.toggle('active', i<=d.n);
                }
            });
        });

        function renderFinal() {
            let html = '<div class="final-container"><div>';
            for(let i=0; i<5; i++) html += `<div class="row"><div class="row-txt ${currentData.p1[i]?.rev ? '' : 'dots'}">${currentData.p1[i]?.rev ? currentData.p1[i].t : ''}</div><div class="row-pts">${currentData.p1[i]?.rev ? currentData.p1[i].p : ''}</div></div>`;
            html += '</div><div>';
            for(let i=0; i<5; i++) html += `<div class="row"><div class="row-txt ${currentData.p2[i]?.rev ? '' : 'dots'}">${currentData.p2[i]?.rev ? currentData.p2[i].t : ''}</div><div class="row-pts">${currentData.p2[i]?.rev ? currentData.p2[i].p : ''}</div></div>`;
            html += '</div></div>';
            display.innerHTML = html;
        }
    </script>
</body>
</html>
