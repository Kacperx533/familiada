<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>FAMILIADA TV - FULL LED</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { 
            --led-on: #dfff00; 
            --led-red: #ff3333;
            --led-off: #222;
            --bg-dark: #101010;
        }
        
        body { 
            background-color: var(--bg-dark);
            color: var(--led-on);
            font-family: 'VT323', monospace; 
            margin: 0; 
            overflow: hidden; 
            height: 100vh; 
            /* Tło imitujące moduły tablicy */
            background-image: 
                linear-gradient(90deg, #000 2px, transparent 2px), 
                linear-gradient(#000 2px, transparent 2px);
            background-size: 50px 50px; 
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* WARSTWA "KROPEK" - Efekt LED */
        .led-overlay {
            position: fixed;
            inset: 0;
            background-image: radial-gradient(circle, transparent 30%, #000 90%);
            background-size: 6px 6px; 
            pointer-events: none;
            z-index: 1000;
            opacity: 0.5;
        }

        /* GŁÓWNY UKŁAD */
        .main-stage {
            display: grid;
            grid-template-columns: 100px 1fr 100px; /* Lewo - Tablica - Prawo */
            width: 95vw;
            height: 85vh;
            gap: 20px;
            align-items: start;
        }

        /* WSKAŹNIKI BOCZNE (X) */
        .side-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding-top: 50px;
        }
        
        .indicator-box {
            width: 80px;
            height: 80px;
            border: 4px solid #333;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 60px;
            color: var(--led-off); /* Domyślnie wygaszone */
            transition: 0.2s;
        }

        .indicator-box.active {
            color: var(--led-red);
            text-shadow: 0 0 20px var(--led-red);
            border-color: #500;
        }

        /* TABLICA CENTRALNA */
        .board-wrapper {
            display: flex;
            flex-direction: column;
            position: relative;
            height: 100%;
        }

        .row { 
            display: flex; 
            align-items: center; 
            height: 12vh; 
            font-size: 7vh; 
            letter-spacing: 5px; 
            text-shadow: 0 0 10px var(--led-on); 
            border-bottom: 2px solid #000;
            background: rgba(20, 20, 20, 0.5);
        }

        .row-num { width: 80px; text-align: center; color: var(--led-on); }
        .row-txt { flex-grow: 1; padding-left: 20px; white-space: nowrap; overflow: hidden; }
        .row-pts { width: 120px; text-align: right; padding-right: 20px; }
        .dots-placeholder::after { content: "......................"; opacity: 0.3; letter-spacing: 2px; }

        /* SUMA i WYNIKI DRUŻYN NA DOLE */
        .footer-info {
            margin-top: auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: #000;
            border: 2px solid #333;
        }
        
        .team-score { font-size: 5vh; color: #fff; }
        .total-sum { font-size: 8vh; color: var(--led-on); text-shadow: 0 0 15px var(--led-on); }

        /* DUŻY X NA ŚRODEK (przy błędzie) */
        .strike-overlay {
            position: fixed;
            inset: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            z-index: 2000;
        }
        .strike-center {
            font-size: 60vh;
            color: var(--led-red);
            text-shadow: 5px 5px 0 #000, 0 0 40px var(--led-red);
            display: none;
        }

        /* ID i START */
        #start-screen { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; color:white;}
        
        /* WIDEO */
        #vid-layer { position: fixed; inset: 0; background:black; z-index:5000; display:none; }
        video { width:100%; height:100%; }

    </style>
</head>
<body>

    <div class="led-overlay"></div>
    
    <div id="start-screen">
        <h1 style="color:var(--led-on)">SYSTEM FAMILIADA LED</h1>
        <div id="my-id" style="font-family:sans-serif; margin-bottom:20px;">Generowanie ID...</div>
        <button onclick="startSystem()" style="padding:15px 40px; font-size:20px; font-weight:bold; cursor:pointer;">URUCHOM EKRAN</button>
    </div>

    <div id="vid-layer"><video id="player"></video></div>

    <div class="strike-overlay"><div id="big-strike" class="strike-center">X</div></div>

    <div class="main-stage">
        
        <div class="side-panel">
            <div class="indicator-box" id="L1">X</div>
            <div class="indicator-box" id="L2">X</div>
            <div class="indicator-box" id="L3">X</div>
        </div>

        <div class="board-wrapper">
            <div id="rows-container"></div>
            
            <div class="footer-info">
                <div class="team-score" style="color: #44f;">NIEB: <span id="s1-display">0</span></div>
                <div class="total-sum">SUMA: <span id="total-sum">0</span></div>
                <div class="team-score" style="color: #f44;">CZER: <span id="s2-display">0</span></div>
            </div>
        </div>

        <div class="side-panel">
            <div class="indicator-box" id="R1">X</div>
            <div class="indicator-box" id="R2">X</div>
            <div class="indicator-box" id="R3">X</div>
        </div>

    </div>

    <audio id="snd-intro" src="intro.mp3"></audio>
    <audio id="snd-ok" src="ok.mp3"></audio>
    <audio id="snd-bad" src="zla.mp3"></audio>
    <audio id="snd-rep" src="rep.mp3"></audio> <script>
        const peer = new Peer();
        peer.on('open', id => document.getElementById('my-id').innerText = "TWÓJ KOD ID: " + id);

        function startSystem() {
            document.getElementById('start-screen').style.display = 'none';
        }

        // Rysowanie pustej tablicy
        function renderBoard(data) {
            const container = document.getElementById('rows-container');
            container.innerHTML = '';
            for(let i=0; i<6; i++) {
                let contentHTML = `<div class="row-txt dots-placeholder"></div>`;
                let ptsHTML = `<div class="row-pts"></div>`;
                
                if (data.ans && data.ans[i]) {
                    if (data.ans[i].revealed) {
                        contentHTML = `<div class="row-txt">${data.ans[i].t}</div>`;
                        ptsHTML = `<div class="row-pts">${data.ans[i].p}</div>`;
                    }
                }
                container.innerHTML += `
                    <div class="row">
                        <div class="row-num">${i+1}</div>
                        ${contentHTML}
                        ${ptsHTML}
                    </div>
                `;
            }
        }
        renderBoard({ans: []});

        let currentAns = [];

        peer.on('connection', conn => {
            conn.on('data', data => {
                
                if(data.type === 'SETUP') {
                    currentAns = data.ans.map(a => ({...a, revealed: false}));
                    renderBoard({ans: currentAns});
                    // Reset bocznych wskaźników
                    ['L1','L2','L3','R1','R2','R3'].forEach(id => document.getElementById(id).classList.remove('active'));
                }

                if(data.type === 'REV') {
                    document.getElementById('snd-ok').play();
                    if(currentAns[data.idx]) {
                        currentAns[data.idx].revealed = true;
                        renderBoard({ans: currentAns});
                    }
                }

                if(data.type === 'SCORE_UPDATE') {
                    document.getElementById('s1-display').innerText = data.s1;
                    document.getElementById('s2-display').innerText = data.s2;
                    document.getElementById('total-sum').innerText = data.sum;
                }

                // Obsługa bocznych X
                if(data.type === 'SIDE_STRIKE') {
                    document.getElementById('snd-bad').play();
                    // data.side = 'L' lub 'R', data.count = 1, 2 lub 3
                    // Reset strony
                    for(let i=1; i<=3; i++) document.getElementById(data.side+i).classList.remove('active');
                    // Zapalanie odpowiedniej ilości
                    for(let i=1; i<=data.count; i++) document.getElementById(data.side+i).classList.add('active');
                    
                    // Pokazanie dużego X na chwilę
                    const bigX = document.getElementById('big-strike');
                    bigX.style.display = 'block';
                    setTimeout(() => bigX.style.display = 'none', 1500);
                }
                
                // Czysty reset X
                if(data.type === 'CLEAR_STRIKES') {
                     ['L1','L2','L3','R1','R2','R3'].forEach(id => document.getElementById(id).classList.remove('active'));
                }

                if(data.type === 'SOUND') {
                    const audio = document.getElementById('snd-' + data.file);
                    if(audio) { audio.currentTime = 0; audio.play(); }
                }

                if(data.type === 'VIDEO') {
                    const v = document.getElementById('player');
                    document.getElementById('vid-layer').style.display='block';
                    v.src = 'czolowka.mp4'; 
                    v.play();
                    v.onended = () => document.getElementById('vid-layer').style.display='none';
                }
            });
        });
    </script>
</body>
</html>
