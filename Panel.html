<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>PANEL STEROWANIA</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; display: grid; grid-template-columns: 350px 1fr 300px; gap: 15px; padding: 15px; }
        .card { background: #2a2a2a; padding: 15px; border-radius: 8px; border-top: 4px solid #dfff00; }
        button { background: #444; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; margin-bottom: 5px; }
        .btn-gold { background: #dfff00; color: black; }
        .btn-red { background: #aa0000; }
        input, select { width: 100%; padding: 10px; background: #000; color: #fff; border: 1px solid #444; border-radius: 5px; margin-bottom: 10px; box-sizing: border-box; }
        .score-box { font-size: 32px; text-align: center; color: #dfff00; background: #000; padding: 10px; margin: 5px 0; }
    </style>
</head>
<body>

    <div>
        <div class="card">
            <h3>1. PO≈ÅƒÑCZENIE</h3>
            <input id="tv-id" placeholder="Wpisz KOD z TV">
            <button class="btn-gold" onclick="connect()">PO≈ÅƒÑCZ Z TV</button>
            <div id="status" style="text-align:center; color:red; margin-top:5px">NIEPO≈ÅƒÑCZONO</div>
        </div>

        <div class="card" style="margin-top:15px">
            <h3>2. RUNDY I MULTIMEDIA</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px">
                <button onclick="startRunda(1)">RUNDA 1</button>
                <button onclick="startRunda(2)">RUNDA 2</button>
                <button onclick="startRunda(3)">RUNDA 3</button>
                <button onclick="startRunda(4)">RUNDA 4</button>
            </div>
            <button class="btn-gold" onclick="startFinal()">üèÜ FINA≈Å (WIDEO + AUDIO)</button>
            <button class="btn-red" onclick="send({type:'STOP_VIDEO'})">STOP WIDEO</button>
        </div>
    </div>

    <div>
        <div class="card">
            <h3>3. TABLICA G≈Å√ìWNA</h3>
            <select id="q-select" onchange="previewQ()"></select>
            <button class="btn-gold" onclick="sendQ()">ZA≈ÅADUJ PYTANIE</button>
            <div id="ans-preview" style="margin-top:10px"></div>
            <div class="score-box">SUMA: <span id="current-sum">0</span></div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
                <button onclick="sendX(1)">X</button>
                <button onclick="send({type:'X', side:'L', n:0})">CZY≈öƒÜ X</button>
            </div>
        </div>
    </div>

    <div>
        <div class="card">
            <h3>4. KONTROLA FINA≈ÅU</h3>
            <button onclick="send({type:'SETUP_FINAL'})">POKA≈ª TABELƒò FINA≈ÅU</button>
            <div style="display:flex; gap:5px; margin:10px 0">
                <button onclick="runTimer(15)">15s</button>
                <button onclick="runTimer(20)">20s</button>
            </div>
            <div id="final-ui">
                <div id="f-p1"><b>GRACZ 1</b></div>
                <div id="f-p2" style="margin-top:10px"><b>GRACZ 2</b></div>
            </div>
        </div>
    </div>

    <script>
        const DB = [
            {q:"Zwierzƒô na K", a:[["KOT",40],["KO≈É",25],["KROWA",15],["KANGUR",10]]},
            {q:"Przedmiot szkolny", a:[["MATEMATYKA",40],["POLSKI",30],["WF",20]]}
        ];

        let peer = new Peer(), conn, activeSide = 'L', sum = 0;

        function connect() {
            conn = peer.connect(document.getElementById('tv-id').value);
            conn.on('open', () => {
                document.getElementById('status').innerText = "PO≈ÅƒÑCZONO";
                document.getElementById('status').style.color = "lime";
            });
        }

        window.onload = () => {
            const sel = document.getElementById('q-select');
            DB.forEach((x,i) => sel.innerHTML += `<option value="${i}">${x.q}</option>`);
            ['p1','p2'].forEach(p => {
                const div = document.getElementById('f-'+p);
                for(let i=0; i<5; i++) div.innerHTML += `<div style="display:flex; gap:2px"><input id="f-${p}-t-${i}" placeholder="Odp" style="font-size:10px"><input id="f-${p}-p-${i}" type="number" placeholder="0" style="width:40px"><button onclick="revealFinal('${p}',${i})" style="padding:2px">OK</button></div>`;
            });
        };

        function startRunda(n) { send({type:'PLAY_MEDIA', video:'runda.mp4', audio:'runda'}); }
        function startFinal() { send({type:'PLAY_MEDIA', video:'final.mp4', audio:'final'}); }
        
        function sendQ() {
            sum = 0; updateSum();
            const q = DB[document.getElementById('q-select').value];
            send({type:'SETUP_NORMAL', ans: q.a.map(x=>({t:x[0], p:x[1]}))});
            previewQ();
        }

        function previewQ() {
            const q = DB[document.getElementById('q-select').value];
            document.getElementById('ans-preview').innerHTML = q.a.map((x,i) => `
                <button onclick="revNormal(${i},${x[1]})">${x[0]} (${x[1]})</button>
            `).join('');
        }

        function revNormal(i,p) { sum+=p; updateSum(); send({type:'REV_NORMAL', idx:i}); send({type:'SCORE', val:sum}); }
        function updateSum() { document.getElementById('current-sum').innerText = sum; }

        function revealFinal(p,i) {
            const t = document.getElementById(`f-${p}-t-${i}`).value.toUpperCase();
            const pts = parseInt(document.getElementById(`f-${p}-p-${i}`).value) || 0;
            sum += pts; updateSum();
            send({type:'REV_FINAL', player:p, idx:i, t:t, p:pts});
            send({type:'SCORE', val:sum});
        }

        function sendX(n) { send({type:'X', side:'L', n:n}); }
        function runTimer(s) {
            let c = s; send({type:'TIMER', action:'start', val:c});
            let itv = setInterval(() => { c--; if(c<=0){ clearInterval(itv); send({type:'TIMER', action:'stop'}); } send({type:'TIMER', action:'tick', val:c}); }, 1000);
        }
        function send(d) { if(conn) conn.send(d); }
    </script>
</body>
</html>
