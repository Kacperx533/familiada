<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>PANEL STEROWANIA - FAMILIADA</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; padding: 20px; display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
        .card { background: #2a2a2a; padding: 15px; border-radius: 8px; border-top: 4px solid #dfff00; }
        .btn-gold { background: #dfff00; color: black; font-weight: bold; padding: 10px; cursor: pointer; border: none; width: 100%; margin: 5px 0; }
        .btn-blue { background: #0055ff; color: white; border: none; padding: 10px; cursor: pointer; }
        .active-team { outline: 4px solid lime; }
        input { width: 100%; padding: 8px; background: #000; color: #fff; border: 1px solid #444; box-sizing: border-box; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    </style>
</head>
<body>
    <div>
        <div class="card">
            <h3>1. POŁĄCZENIE</h3>
            <input id="tv-id" placeholder="Wpisz ID z TV">
            <button class="btn-gold" onclick="connect()">POŁĄCZ</button>
        </div>

        <div class="card" style="margin-top:20px">
            <h3>2. RUNDY (Z AUTOMATYKĄ DŹWIĘKU)</h3>
            <div class="grid-2">
                <button onclick="startRunda(1)">RUNDA 1</button>
                <button onclick="startRunda(2)">RUNDA 2</button>
                <button onclick="startRunda(3)">RUNDA 3</button>
                <button class="btn-gold" onclick="startFinal()">FINAŁ (MUZYKA)</button>
            </div>
        </div>

        <div class="card" style="margin-top:20px">
            <h3>3. BŁĘDY (X)</h3>
            <div class="grid-2">
                <button class="btn-blue" id="t-L" onclick="activeSide='L'">DRUŻYNA LEWA</button>
                <button class="btn-blue" id="t-R" onclick="activeSide='R'">DRUŻYNA PRAWA</button>
            </div>
            <div style="display:flex; gap:5px; margin-top:10px">
                <button style="flex:1" onclick="sendX(1)">X</button>
                <button style="flex:1" onclick="sendX(2)">XX</button>
                <button style="flex:1" onclick="sendX(3)">XXX</button>
            </div>
        </div>
    </div>

    <div>
        <div class="card">
            <h3>4. TABLICA GŁÓWNA / FINAŁOWA</h3>
            <div id="setup-area">
                <select id="q-select" style="width:100%; padding:10px" onchange="updatePreview()"></select>
                <button class="btn-gold" onclick="sendQ()">WYŚLIJ PYTANIE NA TV</button>
                <div id="ans-preview" style="margin-top:10px"></div>
            </div>

            <div id="final-area" style="display:none; margin-top:20px; border-top: 2px solid #555; padding-top:10px">
                <div class="grid-2">
                    <button onclick="runTimer(15)">STOPER 15s</button>
                    <button onclick="runTimer(20)">STOPER 20s</button>
                </div>
                <div class="grid-2" style="margin-top:10px">
                    <div id="f-p1"><h4>GRACZ 1</h4></div>
                    <div id="f-p2"><h4>GRACZ 2</h4></div>
                </div>
            </div>
            <div style="text-align:right; font-size:24px; color:gold; margin-top:10px">SUMA: <span id="local-sum">0</span></div>
        </div>
    </div>

    <script>
        const DB = [
            {q:"Zwierzę na literę K", a:[["KOT",45],["KOŃ",25],["KROWA",15],["KANGUR",10]]},
            {q:"Przedmiot szkolny", a:[["MATEMATYKA",40],["POLSKI",30],["WF",20]]}
        ];

        let peer = new Peer(), conn, activeSide = 'L', totalSum = 0;

        function connect() { conn = peer.connect(document.getElementById('tv-id').value); }

        window.onload = () => {
            const sel = document.getElementById('q-select');
            DB.forEach((x, i) => sel.innerHTML += `<option value="${i}">${x.q}</option>`);
            
            // Generowanie pól finałowych
            ['p1', 'p2'].forEach(p => {
                const container = document.getElementById('f-' + p);
                for(let i=0; i<5; i++) {
                    container.innerHTML += `
                        <div style="margin-bottom:5px">
                            <input id="f-${p}-t-${i}" placeholder="Odp" style="width:70%">
                            <input id="f-${p}-p-${i}" type="number" placeholder="Pkt" style="width:25%">
                            <button onclick="revealFinal('${p}', ${i})" style="width:100%">ODKRYJ</button>
                        </div>`;
                }
            });
            updatePreview();
        };

        function startRunda(n) {
            send({type:'SOUND', file:'runda'});
            send({type:'ROUND_START', num: n});
            document.getElementById('setup-area').style.display = 'block';
            document.getElementById('final-area').style.display = 'none';
        }

        function startFinal() {
            send({type:'SOUND', file:'final'});
            send({type:'SETUP_FINAL'});
            document.getElementById('setup-area').style.display = 'none';
            document.getElementById('final-area').style.display = 'block';
            totalSum = 0; document.getElementById('local-sum').innerText = 0;
        }

        function sendQ() {
            totalSum = 0; document.getElementById('local-sum').innerText = 0;
            const q = DB[document.getElementById('q-select').value];
            send({type:'SETUP_NORMAL', ans: q.a.map(x=>({t:x[0], p:x[1]}))});
            updatePreview();
        }

        function updatePreview() {
            const q = DB[document.getElementById('q-select').value];
            const box = document.getElementById('ans-preview');
            box.innerHTML = q.a.map((x, i) => `
                <button onclick="revealNormal(${i}, ${x[1]})" style="width:100%; text-align:left; margin:2px">
                    ${x[0]} (${x[1]})
                </button>`).join('');
        }

        function revealNormal(idx, pts) {
            totalSum += pts;
            document.getElementById('local-sum').innerText = totalSum;
            send({type:'REV_NORMAL', idx: idx});
            send({type:'SCORE', val: totalSum});
        }

        function revealFinal(player, idx) {
            const t = document.getElementById(`f-${player}-t-${idx}`).value.toUpperCase();
            const p = parseInt(document.getElementById(`f-${player}-p-${idx}`).value) || 0;
            totalSum += p;
            document.getElementById('local-sum').innerText = totalSum;
            send({type:'REV_FINAL', player: player, idx: idx, t: t, p: p});
            send({type:'SCORE', val: totalSum});
        }

        function sendX(n) { send({type:'X', side: activeSide, n: n}); }
        
        function runTimer(sec) {
            let c = sec;
            send({type:'TIMER', action:'start', val:c});
            let itv = setInterval(() => {
                c--;
                if(c <= 0) { clearInterval(itv); send({type:'TIMER', action:'stop'}); }
                send({type:'TIMER', action:'tick', val:c});
            }, 1000);
        }

        function send(d) { if(conn) conn.send(d); }
    </script>
</body>
</html>
